# åŠ¨æ‰‹å°è¯•ï¼šè¿›é˜¶æ·±åº¦å¼ºåŒ–å­¦ä¹ ã€‚ä½¿ç”¨ Sample Factory æ¡†æ¶è¾“å…¥åƒç´ ç© Doom

<CourseFloatingBanner classNames="absolute z-10 right-0 top-0"
notebooks={[
  {label: "Google Colab", value: "https://colab.research.google.com/github/huggingface/deep-rl-class/blob/main/notebooks/unit8/unit8_part2.ipynb"}
  ]}
  askForHelpUrl="http://hf.co/join/discord" />

colab notebook:
[![åœ¨ Colab ä¸­æ‰“å¼€](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/github/huggingface/deep-rl-class/blob/master/notebooks/unit8/unit8_part2.ipynb)

# ç¬¬ 8 å•å…ƒç¬¬ 2 éƒ¨åˆ†ï¼šé«˜çº§æ·±åº¦å¼ºåŒ–å­¦ä¹ ã€‚ä½¿ç”¨ Sample Factory æ¡†æ¶è¾“å…¥åƒç´ ç© Doom

<img src="https://huggingface.co/datasets/huggingface-deep-rl-course/course-images/resolve/main/en/unit9/thumbnail2.png" alt="Thumbnail"/>

æœ¬ notebook å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Doom æ¸¸æˆçš„ä¸‰ç»´ç¯å¢ƒè®­ç»ƒæ·±åº¦ç¥ç»ç½‘ç»œä»¥æ”¶é›†ç‰©å“ï¼Œä¸‹é¢æ˜¯ç”Ÿæˆçš„ç­–ç•¥çš„è§†é¢‘ã€‚æˆ‘ä»¬ä½¿ç”¨å¼‚æ­¥å®ç°çš„ PPO ç®—æ³• [Sample Factory](https://www.samplefactory.dev/) è®­ç»ƒè¯¥ç­–ç•¥ã€‚

è¯·æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

* [Sample Factory](https://www.samplefactory.dev/) æ˜¯ä¸€ä¸ªé«˜çº§çš„ RL æ¡†æ¶ï¼Œ**ä»…åœ¨ Linux å’Œ Mac ä¸Šè¿è¡Œ**ï¼ˆä¸æ”¯æŒ Windowsï¼‰ã€‚

* è¯¥æ¡†æ¶åœ¨**å…·æœ‰è®¸å¤š CPU æ ¸å¿ƒçš„ GPU è®¡ç®—æœºä¸Šè¡¨ç°æœ€ä½³**ï¼Œåœ¨è¿™ç§è®¾ç½®ä¸‹å®ƒå¯ä»¥è¾¾åˆ°æ¯ç§’ 10 ä¸‡ä¸ªäº¤äº’çš„é€Ÿåº¦ã€‚æ ‡å‡†çš„ Colab ç¬”è®°æœ¬å¯ç”¨çš„èµ„æº**é™åˆ¶äº†è¯¥åº“çš„æ€§èƒ½**ã€‚å› æ­¤ï¼Œåœ¨è¿™ç§è®¾ç½®ä¸‹çš„é€Ÿåº¦**ä¸åæ˜ å®é™…çš„æ€§èƒ½**ã€‚

* å¦‚æœæ‚¨æƒ³äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[ç¤ºä¾‹](https://github.com/alex-petrenko/sample-factory/tree/master/sf_examples)ä¸­çš„ Sample Factory åŸºå‡†æµ‹è¯•ã€‚


```python
from IPython.display import HTML

HTML(
    """<video width="640" height="480" controls>
  <source src="https://huggingface.co/edbeeching/doom_health_gathering_supreme_3333/resolve/main/replay.mp4"
  type="video/mp4">Your browser does not support the video tag.</video>"""
)
```

ä¸ºäº†éªŒè¯æœ¬æ¬¡åŠ¨æ‰‹å°è¯•çš„[è®¤è¯è¿‡ç¨‹](https://huggingface.co/deep-rl-course/en/unit0/introduction#certification-process)ï¼Œä½ éœ€è¦æ¨é€ä¸€ä¸ªæ¨¡å‹

- `doom_health_gathering_supreme` è·å¾—ç»“æœ >= 5.

æ‰¾åˆ°ä½ çš„ç»“æœ å» [leaderboard](https://huggingface.co/spaces/huggingface-projects/Deep-Reinforcement-Learning-Leaderboard) æ‰¾åˆ°ä½ çš„æ¨¡å‹,**ç»“æœ = å¹³å‡å¥–åŠ± - æ ‡å‡†å·®å¥–åŠ±**

å¦‚æœä½ æ‰¾ä¸åˆ°ä½ çš„æ¨¡å‹ï¼Œ**è¯·è½¬åˆ°é¡µé¢åº•éƒ¨å¹¶ç‚¹å‡»åˆ·æ–°æŒ‰é’®**

æœ‰å…³è®¤è¯è¿‡ç¨‹çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹æ­¤éƒ¨åˆ† ğŸ‘‰ https://huggingface.co/deep-rl-course/en/unit0/introduction#certification-process

## è®¾ç½® GPU  ğŸ’ª

- ä¸ºäº† **åŠ é€Ÿæ™ºèƒ½ä½“çš„è®­ç»ƒï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ GPU**. ç‚¹å‡» `Runtime > Change Runtime type`

<img src="https://huggingface.co/datasets/huggingface-deep-rl-course/course-images/resolve/main/en/notebooks/gpu-step1.jpg" alt="GPU Step 1">

- `Hardware Accelerator > GPU`

<img src="https://huggingface.co/datasets/huggingface-deep-rl-course/course-images/resolve/main/en/notebooks/gpu-step2.jpg" alt="GPU Step 2">

åœ¨å¼€å§‹è®­ç»ƒæˆ‘ä»¬çš„æ™ºèƒ½ä½“ä¹‹å‰ï¼Œè®©æˆ‘**å­¦ä¹ ä¸€ä¸‹æˆ‘ä»¬å°†è¦ä½¿ç”¨çš„åº“ä¸ç¯å¢ƒ**ã€‚

## Sample Factory

[Sample Factory](https://www.samplefactory.dev/) æ˜¯**æœ€å¿«çš„å¼ºåŒ–å­¦ä¹ åº“ä¹‹ä¸€ï¼Œä¸“æ³¨äºéå¸¸é«˜æ•ˆçš„åŒæ­¥å’Œå¼‚æ­¥ç­–ç•¥æ¢¯åº¦ï¼ˆ PPO ï¼‰å®ç°ã€‚**

Sample Factory ç»è¿‡äº†å……åˆ†**çš„æµ‹è¯•ï¼Œè¢«è®¸å¤šç ”ç©¶äººå‘˜å’Œä»ä¸šè€…ä½¿ç”¨**ï¼Œå¹¶ä¸”æ­£åœ¨ç§¯æç»´æŠ¤ã€‚æˆ‘ä»¬çš„å®ç°åœ¨**å„ç§é¢†åŸŸå·²çŸ¥è¾¾åˆ°äº† SOTA æ€§èƒ½ï¼Œå¹¶å°½é‡å‡å°‘äº†å¼ºåŒ–å­¦ä¹ å®éªŒè®­ç»ƒæ—¶é—´å’Œç¡¬ä»¶éœ€æ±‚ã€‚**

<img src="https://huggingface.co/datasets/huggingface-deep-rl-course/course-images/resolve/main/en/unit9/samplefactoryenvs.png" alt="Sample factory"/>

### å…³é”®ç‰¹å¾

- é«˜åº¦ä¼˜åŒ–çš„ç®—æ³•[æ¶æ„](https://www.samplefactory.dev/06-architecture/overview/)Â ï¼Œæœ€å¤§ç¨‹åº¦åœ°æé«˜å­¦ä¹ ååé‡ 
- [åŒæ­¥å’Œå¼‚æ­¥](https://www.samplefactory.dev/07-advanced-topics/sync-async/)çš„è®­ç»ƒæ¨¡å¼
- [ä¸²è¡Œï¼ˆå•è¿›ç¨‹ï¼‰æ¨¡å¼](https://www.samplefactory.dev/07-advanced-topics/serial-mode/)ï¼Œæ–¹ä¾¿è°ƒè¯•
- åœ¨åŸºäº CPU å’Œ[ GPU åŠ é€Ÿçš„ç¯å¢ƒ](https://www.samplefactory.dev/09-environment-integrations/isaacgym/)ä¸­å‡èƒ½å®ç°æœ€ä½³æ€§èƒ½
- å•æ™ºèƒ½ä½“å’Œå¤šæ™ºèƒ½ä½“è®­ç»ƒã€è‡ªæˆ‘å¯¹å¼ˆï¼Œæ”¯æŒåœ¨ä¸€ä¸ªæˆ–å¤šä¸ª GPU ä¸ŠåŒæ—¶è®­ç»ƒ[å¤šä¸ªç­–ç•¥](https://www.samplefactory.dev/07-advanced-topics/multi-policy-training/)
- åŸºäºç§ç¾¤çš„è®­ç»ƒï¼ˆ[PBT](https://www.samplefactory.dev/07-advanced-topics/pbt/)ï¼‰
- ç¦»æ•£ã€è¿ç»­ã€æ··åˆåŠ¨ä½œç©ºé—´
- å‘é‡ã€å›¾åƒã€å­—å…¸è§‚æµ‹ç©ºé—´
- é€šè¿‡è§£æåŠ¨ä½œ/è§‚æµ‹ç©ºé—´è§„èŒƒè‡ªåŠ¨åˆ›å»ºæ¨¡å‹æ¶æ„ã€‚æ”¯æŒ[è‡ªå®šä¹‰æ¨¡å‹æ¶æ„](https://www.samplefactory.dev/03-customization/custom-models/)
- è®¾è®¡æˆå¯å¯¼å…¥å…¶ä»–é¡¹ç›®ï¼Œ[è‡ªå®šä¹‰ç¯å¢ƒ](https://www.samplefactory.dev/03-customization/custom-environments/)æ˜¯ä¸€ç­‰å…¬æ°‘
- è¯¦ç»†çš„[ WandB å’Œ Tensorboard æ‘˜è¦](https://www.samplefactory.dev/05-monitoring/metrics-reference/)ã€[è‡ªå®šä¹‰æŒ‡æ ‡](https://www.samplefactory.dev/05-monitoring/custom-metrics/)
- [HuggingFace ğŸ¤— é›†æˆ](https://www.samplefactory.dev/10-huggingface/huggingface/)ï¼ˆä¸Šä¼ è®­ç»ƒæ¨¡å‹å’ŒæŒ‡æ ‡åˆ° Hubï¼‰
- ä¸å¤šä¸ªèŒƒä¾‹ç¯å¢ƒé›†æˆï¼Œå¸¦æœ‰ç»è¿‡è°ƒæ•´çš„å‚æ•°å’Œè®­ç»ƒæ¨¡å‹ï¼ŒåŒ…æ‹¬[Mujoco](https://www.samplefactory.dev/09-environment-integrations/mujoco/)ã€[Atari](https://www.samplefactory.dev/09-environment-integrations/atari/)ã€[VizDoom](https://www.samplefactory.dev/09-environment-integrations/vizdoom/)ã€[DMlab](https://www.samplefactory.dev/09-environment-integrations/dmlab/)

ä»¥ä¸Šæ‰€æœ‰ç­–ç•¥éƒ½å¯ä»¥åœ¨ğŸ¤— hubä¸Šè·å¾—ã€‚æœç´¢æ ‡ç­¾[sample-factory](https://huggingface.co/models?library=sample-factory&sort=downloads)ã€‚

### sample-factory æ€ä¹ˆè¿è¡Œ

Sample-factory æ˜¯ç¤¾åŒºä¸­**æœ€é«˜åº¦ä¼˜åŒ–çš„å¼ºåŒ–å­¦ä¹ å®ç°ä¹‹ä¸€**ã€‚

å®ƒé€šè¿‡**ç”Ÿæˆå¤šä¸ªè¿›ç¨‹æ¥è¿è¡Œ rollout workerã€inference worker å’Œ learner worker**ã€‚

*Workers* é€šè¿‡å…±äº«å†…å­˜è¿›è¡Œé€šä¿¡ï¼Œè¿™é™ä½äº†è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡æˆæœ¬ã€‚

*Rollout workers* ä¸ç¯å¢ƒäº¤äº’ï¼Œå¹¶å°†è§‚æµ‹ç»“æœå‘é€ç»™ *inference workers*ã€‚

*Inferences workers* æŸ¥è¯¢ä¸€ä¸ªå›ºå®šç‰ˆæœ¬çš„ç­–ç•¥ï¼Œå¹¶**å°†åŠ¨ä½œå‘é€å› rollout worker**ã€‚

åœ¨ *k* æ­¥ä¹‹åï¼Œrollout workers å°†ç»éªŒè½¨è¿¹å‘é€ç»™ learner workerï¼Œ**å®ƒä½¿ç”¨è¯¥è½¨è¿¹æ¥æ›´æ–°æ™ºèƒ½ä½“çš„ç­–ç•¥ç½‘ç»œ**ã€‚

<img src="https://huggingface.co/datasets/huggingface-deep-rl-course/course-images/resolve/main/en/unit9/samplefactory.png" alt="Sample factory"/>

### Sample-factory ä¸­çš„æ¼”å‘˜-è¯„è®ºå‘˜æ¨¡å‹

åœ¨ Sample Factory ä¸­ï¼Œæ¼”å‘˜-è¯„è®ºå‘˜æ¨¡å‹ç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼š

- **ç¼–ç å™¨** - å¤„ç†è¾“å…¥è§‚æµ‹ï¼ˆå›¾åƒã€å‘é‡ï¼‰å¹¶å°†å®ƒä»¬æ˜ å°„åˆ°ä¸€ä¸ªå‘é‡ã€‚è¿™æ˜¯æ‚¨æœ€æœ‰å¯èƒ½æƒ³è¦è‡ªå®šä¹‰çš„æ¨¡å‹éƒ¨åˆ†ã€‚
- **æ ¸å¿ƒ** - å°†ä¸€ä¸ªæˆ–å¤šä¸ªç¼–ç å™¨çš„å‘é‡é›†æˆï¼Œå¯ä»¥é€‰æ‹©åœ¨åŸºäºè®°å¿†çš„æ™ºèƒ½ä½“ä¸­åŒ…æ‹¬å•å±‚æˆ–å¤šå±‚ LSTM/GRUã€‚
- **è§£ç å™¨** - åœ¨è®¡ç®—ç­–ç•¥å’Œä»·å€¼è¾“å‡ºä¹‹å‰ï¼Œå¯¹æ¨¡å‹æ ¸å¿ƒçš„è¾“å‡ºåº”ç”¨é¢å¤–çš„å±‚ã€‚

è¯¥åº“å·²ç»è¢«è®¾è®¡æˆè‡ªåŠ¨æ”¯æŒä»»ä½•è§‚æµ‹å’ŒåŠ¨ä½œç©ºé—´ã€‚ç”¨æˆ·å¯ä»¥è½»æ¾æ·»åŠ ä»–ä»¬è‡ªå·±çš„è‡ªå®šä¹‰æ¨¡å‹ã€‚ä½ å¯ä»¥åœ¨[æ–‡æ¡£](https://www.samplefactory.dev/03-customization/custom-models/#actor-critic-models-in-sample-factory)ä¸­äº†è§£æ›´å¤šä¿¡æ¯ã€‚

## ViZDoom

[ViZDoom](https://vizdoom.cs.put.edu.pl/) æ˜¯ä¸€ä¸ª**å¼€æºçš„ Doom å¼•æ“çš„ python æ¥å£**ã€‚

è¿™ä¸ªåº“æ˜¯ç”± Marek Wydmuch å’Œ Michal Kempka äº 2016 å¹´åœ¨æ³¢å…°æ³¢å…¹å—ç†å·¥å¤§å­¦çš„è®¡ç®—ç§‘å­¦ç ”ç©¶æ‰€åˆ›å»ºçš„ã€‚

è¯¥åº“ä½¿å¾—åœ¨å¤šç§åœºæ™¯ä¸‹å¯ä»¥**ç›´æ¥ä»å±å¹•åƒç´ ä¸­è®­ç»ƒæ™ºèƒ½ä½“**ï¼ŒåŒ…æ‹¬ä»¥ä¸‹åœºæ™¯ï¼Œä¾‹å¦‚åœ¨ä¸‹é¢çš„è§†é¢‘ä¸­å±•ç¤ºçš„å¤šäººæ¨¡å¼ä¸­çš„æ­»äº¡æ¨¡å¼ã€‚ç”±äº ViZDoom ç¯å¢ƒæ˜¯åŸºäº 90 å¹´ä»£åˆ›å»ºçš„æ¸¸æˆï¼Œæ‰€ä»¥å®ƒå¯ä»¥åœ¨ç°ä»£ç¡¬ä»¶ä¸Šä»¥åŠ é€Ÿçš„é€Ÿåº¦è¿è¡Œï¼Œ**ä»è€Œå…è®¸æˆ‘ä»¬ç›¸å½“å¿«åœ°å­¦ä¹ å¤æ‚çš„ AI è¡Œä¸ºã€‚**

è¯¥åº“çš„åŠŸèƒ½åŒ…æ‹¬ï¼š

- å¤šå¹³å°æ”¯æŒï¼ˆLinuxï¼ŒmacOSï¼ŒWindowsï¼‰
- Python å’Œ C++ çš„ API
- OpenAI Gym ç¯å¢ƒå°è£…å™¨
- æ˜“äºåˆ›å»ºè‡ªå®šä¹‰åœºæ™¯ï¼ˆæä¾›äº†å¯è§†åŒ–ç¼–è¾‘å™¨ã€è„šæœ¬è¯­è¨€å’Œç¤ºä¾‹ï¼‰
- å¼‚æ­¥å’ŒåŒæ­¥çš„å•äººå’Œå¤šäººæ¨¡å¼
- è½»é‡çº§ï¼ˆä»…å‡  MBï¼‰å’Œå¿«é€Ÿï¼ˆåŒæ­¥æ¨¡å¼ä¸‹å•çº¿ç¨‹å¯è¾¾åˆ° 7000fpsï¼‰
- å¯è‡ªå®šä¹‰çš„åˆ†è¾¨ç‡å’Œæ¸²æŸ“å‚æ•°
- å¯è®¿é—®æ·±åº¦ç¼“å†²åŒºï¼ˆ3D è§†è§‰ï¼‰
- è‡ªåŠ¨æ ‡è®°å¸§ä¸­å¯è§çš„æ¸¸æˆå¯¹è±¡
- å¯è®¿é—®éŸ³é¢‘ç¼“å†²åŒº
- å¯è®¿é—®è§’è‰²/å¯¹è±¡å’Œåœ°å›¾å‡ ä½•å½¢çŠ¶çš„åˆ—è¡¨
- å±å¹•å¤–æ¸²æŸ“å’Œåœºæ™¯è®°å½•
- å¼‚æ­¥æ¨¡å¼ä¸­çš„æ—¶é—´ç¼©æ”¾ã€‚

## æˆ‘ä»¬é¦–å…ˆéœ€è¦å®‰è£…ä¸€äº›ä¾èµ–æ¥é€‚é… ViZDoom ç¯å¢ƒ

ç°åœ¨æˆ‘ä»¬çš„ Colab è¿è¡Œç¯å¢ƒå·²ç»è®¾ç½®å¥½äº†ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹å®‰è£…åœ¨ Linux ä¸Šè¿è¡Œ ViZDoom æ‰€éœ€çš„ä¾èµ–é¡¹ã€‚

å¦‚æœä½ æ­£åœ¨ Mac æœºå™¨ä¸Šè¿›è¡Œæ“ä½œï¼Œä½ éœ€è¦æŒ‰ç…§ [github é¡µé¢](https://github.com/Farama-Foundation/ViZDoom/blob/master/doc/Quickstart.md#-quickstart-for-macos-and-anaconda3-python-36)ä¸Šçš„å®‰è£…è¯´æ˜è¿›è¡Œå®‰è£…ã€‚

```python
# Install ViZDoom deps from
# https://github.com/mwydmuch/ViZDoom/blob/master/doc/Building.md#-linux

apt-get install build-essential zlib1g-dev libsdl2-dev libjpeg-dev \
nasm tar libbz2-dev libgtk2.0-dev cmake git libfluidsynth-dev libgme-dev \
libopenal-dev timidity libwildmidi-dev unzip ffmpeg

# Boost libraries
apt-get install libboost-all-dev

# Lua binding dependencies
apt-get install liblua5.1-dev
```

## ç„¶åæˆ‘ä»¬å®‰è£… Sample Factory å’Œ ViZDoom

- è¿™ä¸ªè€—æ—¶ 7 åˆ†é’Ÿå·¦å³

```bash
pip install sample-factory
pip install vizdoom
```

## åœ¨ sample-factory ä¸­è®¾ç½® Doom ç¯å¢ƒ

```python
import functools

from sample_factory.algo.utils.context import global_model_factory
from sample_factory.cfg.arguments import parse_full_cfg, parse_sf_args
from sample_factory.envs.env_utils import register_env
from sample_factory.train import run_rl

from sf_examples.vizdoom.doom.doom_model import make_vizdoom_encoder
from sf_examples.vizdoom.doom.doom_params import add_doom_env_args, doom_override_defaults
from sf_examples.vizdoom.doom.doom_utils import DOOM_ENVS, make_doom_env_from_spec


# Registers all the ViZDoom environments
def register_vizdoom_envs():
    for env_spec in DOOM_ENVS:
        make_env_func = functools.partial(make_doom_env_from_spec, env_spec)
        register_env(env_spec.name, make_env_func)


# Sample Factory allows the registration of a custom Neural Network architecture
# See https://github.com/alex-petrenko/sample-factory/blob/master/sf_examples/vizdoom/doom/doom_model.py for more details
def register_vizdoom_models():
    global_model_factory().register_encoder_factory(make_vizdoom_encoder)


def register_vizdoom_components():
    register_vizdoom_envs()
    register_vizdoom_models()


# parse the command line args and create a config
def parse_vizdoom_cfg(argv=None, evaluation=False):
    parser, _ = parse_sf_args(argv=argv, evaluation=evaluation)
    # parameters specific to Doom envs
    add_doom_env_args(parser)
    # override Doom default values for algo parameters
    doom_override_defaults(parser)
    # second parsing pass yields the final configuration
    final_cfg = parse_full_cfg(parser, argv)
    return final_cfg
```

ç°åœ¨è®¾ç½®å·²ç»å®Œæˆï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹è®­ç»ƒæ™ºèƒ½ä½“ã€‚æˆ‘ä»¬é€‰æ‹©å­¦ä¹ ä¸€ä¸ªåä¸º `Health Gathering Supreme` çš„ ViZDoom ä»»åŠ¡ã€‚

### åœºæ™¯: Health Gathering Supreme

<img src="https://huggingface.co/datasets/huggingface-deep-rl-course/course-images/resolve/main/en/unit9/Health-Gathering-Supreme.png" alt="Health-Gathering-Supreme"/>



è¯¥åœºæ™¯çš„ç›®æ ‡æ˜¯**åœ¨ä¸çŸ¥é“ä»€ä¹ˆä½¿å®ƒå­˜æ´»ä¸‹æ¥çš„æ¡ä»¶ä¸‹æ•™ä¼šæ™ºèƒ½ä½“å¦‚ä½•ç”Ÿå­˜**ã€‚æ™ºèƒ½ä½“ä»…çŸ¥é“**ç”Ÿå‘½å®è´µ**å’Œæ­»äº¡æ˜¯ä¸å¥½çš„ï¼Œå› æ­¤**å®ƒå¿…é¡»å­¦ä¹ ä»€ä¹ˆå¯ä»¥å»¶é•¿å®ƒçš„ç”Ÿå­˜æ—¶é—´ï¼Œä»¥åŠå’Œå®ƒçš„å¥åº·æ¯æ¯ç›¸å…³çš„ä¸œè¥¿**ã€‚

åœ°å›¾æ˜¯ä¸€ä¸ªåŒ…å«å¢™å£å¹¶æœ‰ç»¿è‰²é…¸æ€§åœ°æ¿çš„çŸ©å½¢ï¼Œåœ°æ¿ä¼š**å®šæœŸä¼¤å®³ç©å®¶**ã€‚åˆå§‹æ—¶ï¼Œåœ°å›¾ä¸Šå‡åŒ€åˆ†å¸ƒç€ä¸€äº›åŒ»ç–—åŒ…ã€‚æ¯éš”ä¸€æ®µæ—¶é—´ï¼Œä¼šæœ‰ä¸€ä¸ªæ–°çš„åŒ»ç–—åŒ…ä»å¤©è€Œé™ã€‚**åŒ»ç–—åŒ…å¯ä»¥æ¢å¤ç©å®¶çš„ä¸€äº›å¥åº·å€¼**- ä¸ºäº†ç”Ÿå­˜ï¼Œæ™ºèƒ½ä½“éœ€è¦æ¡èµ·å®ƒä»¬ã€‚ç©å®¶æ­»äº¡æˆ–è¶…æ—¶åï¼Œè¯¥è½®æ¸¸æˆç»“æŸã€‚

æ›´å¤šé…ç½®ä¿¡æ¯ï¼š
- å­˜æ´»å¥–åŠ± = 1
- 3ä¸ªå¯ç”¨æŒ‰é’®ï¼šå‘å·¦è½¬ï¼Œå‘å³è½¬ï¼Œå‘å‰ç§»åŠ¨
- 1ä¸ªå¯ç”¨æ¸¸æˆå˜é‡ï¼šHEALTH
- æ­»äº¡æƒ©ç½š = 100

æ‚¨å¯ä»¥åœ¨ ViZDoom çš„ [è¿™é‡Œ](https://github.com/Farama-Foundation/ViZDoom/tree/master/scenarios) æ‰¾åˆ°æ›´å¤šå¯ç”¨åœºæ™¯çš„ä¿¡æ¯ã€‚

è¿˜æœ‰ä¸€äº›æ›´å¤æ‚çš„åœºæ™¯å·²ç»åœ¨ ViZDoom åˆ›å»ºï¼Œå¦‚[æ­¤ GitHub é¡µé¢](https://github.com/edbeeching/3d_control_deep_rl)æ‰€è¿°ã€‚

## è®­ç»ƒæ™ºèƒ½ä½“

- æˆ‘ä»¬å°†è¦è®­ç»ƒè¿™ä¸ªæ™ºèƒ½ä½“å¤§çº¦ 4000000 æ­¥ï¼Œè¿™å¤§æ¦‚ä¼šè€—è´¹ 20 åˆ†é’Ÿ 

```python
## Start the training, this should take around 15 minutes
register_vizdoom_components()

# The scenario we train on today is health gathering
# other scenarios include "doom_basic", "doom_two_colors_easy", "doom_dm", "doom_dwango5", "doom_my_way_home", "doom_deadly_corridor", "doom_defend_the_center", "doom_defend_the_line"
env = "doom_health_gathering_supreme"
cfg = parse_vizdoom_cfg(
    argv=[f"--env={env}", "--num_workers=8", "--num_envs_per_worker=4", "--train_for_env_steps=4000000"]
)

status = run_rl(cfg)
```

## è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹è®­ç»ƒè¿‡çš„ç­–ç•¥è¡¨ç°å’Œæ™ºèƒ½ä½“çš„è§†é¢‘è¾“å‡ºã€‚

```python
from sample_factory.enjoy import enjoy

cfg = parse_vizdoom_cfg(
    argv=[f"--env={env}", "--num_workers=1", "--save_video", "--no_render", "--max_num_episodes=10"], evaluation=True
)
status = enjoy(cfg)
```

## ç°åœ¨è®©æˆ‘ä»¬å¯è§†åŒ–ä¸€ä¸‹æ™ºèƒ½ä½“çš„è¡¨ç°

```python
from base64 import b64encode
from IPython.display import HTML

mp4 = open("/content/train_dir/default_experiment/replay.mp4", "rb").read()
data_url = "data:video/mp4;base64," + b64encode(mp4).decode()
HTML(
    """
<video width=640 controls>
      <source src="%s" type="video/mp4">
</video>
"""
    % data_url
)
```

è¿™ä¸ªæ™ºèƒ½ä½“ç›®å‰å·²ç»å­¦ä¹ äº†ä¸€äº›ä¸œè¥¿ï¼Œä½†æ˜¯ä»–çš„è¡¨ç°å¯ä»¥æ›´å¥½ã€‚æˆ‘ä»¬æ˜æ˜¾éœ€è¦è®­ç»ƒæ›´ä¹…ï¼Œä½†è®©æˆ‘ä»¬å…ˆæŠŠè¿™ä¸ªæ¨¡å‹ä¸Šä¼ åˆ° Hubã€‚

## ç°åœ¨è®©æˆ‘ä»¬ä¸Šä¼ ä½ çš„å­˜æ¡£ç‚¹å’Œè§†é¢‘åˆ° Hugging Face Hub




ä¸ºäº†èƒ½å¤Ÿåˆ†äº«ä½ çš„æ¨¡å‹åˆ°ç¤¾åŒºï¼Œä½ éœ€è¦éµå¾ªä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ï¼š

1ï¸âƒ£ (å¦‚æœæ²¡æœ‰) åˆ›å»ºä¸€ä¸ª HF è´¦å· â¡ https://huggingface.co/join

2ï¸âƒ£ ç™»é™†, ä»ç½‘ç«™ä¸­è·å–è®¤è¯ tokenã€‚
- åˆ›å»ºä¸€ä¸ªå…·æœ‰**å†™æƒé™**çš„æ–° token (https://huggingface.co/settings/tokens)

<img src="https://huggingface.co/datasets/huggingface-deep-rl-course/course-images/resolve/main/en/notebooks/create-token.jpg" alt="Create HF Token">

- å¤åˆ¶ token
- è¿è¡Œä¸‹é¢å•å…ƒæ ¼ä»£ç å¹¶ç²˜è´´ token

å¦‚æœä½ ä¸æƒ³ä½¿ç”¨ Google Colab æˆ–è€… Jupyter Notebookï¼Œä½ éœ€è¦ç”¨è¿™è¡Œå‘½ä»¤æ›¿ä»£ï¼š`huggingface-cli login` (or `login`)

```python
from huggingface_hub import notebook_login
notebook_login()
!git config --global credential.helper store
```

```python
from sample_factory.enjoy import enjoy

hf_username = "ThomasSimonini"  # insert your HuggingFace username here

cfg = parse_vizdoom_cfg(
    argv=[
        f"--env={env}",
        "--num_workers=1",
        "--save_video",
        "--no_render",
        "--max_num_episodes=10",
        "--max_num_frames=100000",
        "--push_to_hub",
        f"--hf_repository={hf_username}/rl_course_vizdoom_health_gathering_supreme",
    ],
    evaluation=True,
)
status = enjoy(cfg)
```

## è®©æˆ‘ä»¬åŠ è½½æ¨¡å‹


è¿™ä¸ªæ™ºèƒ½ä½“çš„è¡¨ç°ä¸é”™ï¼Œä½†è¿˜æœ‰æå‡çš„ç©ºé—´ï¼è®©æˆ‘ä»¬ä» Hub ä¸‹è½½å¹¶å¯è§†åŒ–ä¸€ä¸ªè®­ç»ƒäº† 10B ä¸ªæ—¶é—´æ­¥çš„æ™ºèƒ½ä½“ã€‚

```bash
#download the agent from the hub
python -m sample_factory.huggingface.load_from_hub -r edbeeching/doom_health_gathering_supreme_2222 -d ./train_dir
```

```bash
ls train_dir/doom_health_gathering_supreme_2222
```

```python
env = "doom_health_gathering_supreme"
cfg = parse_vizdoom_cfg(
    argv=[
        f"--env={env}",
        "--num_workers=1",
        "--save_video",
        "--no_render",
        "--max_num_episodes=10",
        "--experiment=doom_health_gathering_supreme_2222",
        "--train_dir=train_dir",
    ],
    evaluation=True,
)
status = enjoy(cfg)
```

```python
mp4 = open("/content/train_dir/doom_health_gathering_supreme_2222/replay.mp4", "rb").read()
data_url = "data:video/mp4;base64," + b64encode(mp4).decode()
HTML(
    """
<video width=640 controls>
      <source src="%s" type="video/mp4">
</video>
"""
    % data_url
)
```

## ä¸€äº›é¢å¤–çš„æŒ‘æˆ˜ ğŸ†: Doom å¤šäººæ­»äº¡æ¨¡å¼

è®­ç»ƒä¸€ä¸ªåœ¨ Doom çš„å¤šäººæ­»äº¡æ¨¡å¼ä¸­ç©æ¸¸æˆçš„æ™ºèƒ½ä½“ï¼Œéœ€è¦ä½¿ç”¨**æ¯” Colab æ›´é«˜é…ç½®çš„è®¡ç®—æœºï¼Œéœ€è¦å¾ˆå¤šå°æ—¶**ã€‚

å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å·²ç»åœ¨è¿™ä¸ªåœºæ™¯ä¸­è®­ç»ƒè¿‡ä¸€ä¸ªæ™ºèƒ½ä½“ï¼Œå¹¶ä¸”å®ƒå·²ç»å¯ä»¥åœ¨ ğŸ¤— Hub ä¸Šè·å–ï¼ **è®©æˆ‘ä»¬ä¸‹è½½è¿™ä¸ªæ¨¡å‹å¹¶å¯è§†åŒ–æ™ºèƒ½ä½“çš„è¡¨ç°ã€‚**

```python
# Download the agent from the hub
python -m sample_factory.huggingface.load_from_hub -r edbeeching/doom_deathmatch_bots_2222 -d ./train_dir
```

é‰´äºæ™ºèƒ½ä½“é•¿æ—¶é—´è¿›è¡Œæ¸¸æˆï¼Œè§†é¢‘ç”Ÿæˆå¯èƒ½éœ€è¦**10åˆ†é’Ÿ**ã€‚

```python
from sample_factory.enjoy import enjoy

register_vizdoom_components()
env = "doom_deathmatch_bots"
cfg = parse_vizdoom_cfg(
    argv=[
        f"--env={env}",
        "--num_workers=1",
        "--save_video",
        "--no_render",
        "--max_num_episodes=1",
        "--experiment=doom_deathmatch_bots_2222",
        "--train_dir=train_dir",
    ],
    evaluation=True,
)
status = enjoy(cfg)
mp4 = open("/content/train_dir/doom_deathmatch_bots_2222/replay.mp4", "rb").read()
data_url = "data:video/mp4;base64," + b64encode(mp4).decode()
HTML(
    """
<video width=640 controls>
      <source src="%s" type="video/mp4">
</video>
"""
    % data_url
)
```


ä½ **å¯ä»¥å°è¯•ä½¿ç”¨ä¸Šé¢çš„ä»£ç åœ¨è¿™ä¸ªç¯å¢ƒä¸­è®­ç»ƒä½ çš„æ™ºèƒ½ä½“**ï¼Œä½†ä¸èƒ½åœ¨ Colab ä¸Šè®­ç»ƒã€‚
**ç¥ä½ å¥½è¿ ğŸ¤**

å¦‚æœä½ å–œæ¬¢ä¸€ä¸ªæ›´ç®€å•çš„åœºæ™¯ï¼Œ**ä¸ºä»€ä¹ˆä¸å°è¯•åœ¨å¦ä¸€ä¸ª ViZDoom åœºæ™¯ä¸­è®­ç»ƒï¼Œä¾‹å¦‚ `doom_deadly_corridor` æˆ– `doom_defend_the_center`ã€‚**

---

è¿™å°±ç»“æŸäº†æœ€åä¸€ä¸ªå•å…ƒã€‚ä½†æˆ‘ä»¬è¿˜æ²¡æœ‰ç»“æŸï¼ğŸ¤— ä¸‹é¢çš„ **é¢å¤–ç« èŠ‚åŒ…æ‹¬ä¸€äº›æœ€æœ‰è¶£ã€æœ€å…ˆè¿›å’Œæœ€å‰æ²¿çš„æ·±åº¦å¼ºåŒ–å­¦ä¹ å·¥ä½œ**ã€‚

## ä¿æŒçƒ­çˆ±ï¼Œå¥”èµ´å±±æµ· ğŸ¤—
